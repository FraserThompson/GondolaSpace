"use strict";angular.module("publicApp",["ngAnimate","ngCookies","ngResource","ui.router","ngSanitize","ngTouch","ezfb"]).config(["$stateProvider","$urlRouterProvider","ezfbProvider",function(a,b,c){c.setLocale("en_NZ"),c.setInitParams({appId:"156068884749797",version:"v2.5"}),b.otherwise("/"),a.state("home",{url:"/:gondola",templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).state("profile",{url:"/profile/:id",templateUrl:"views/profile.html",controller:"ProfileCtrl",controllerAs:"profile"})}]),angular.module("publicApp").directive("fileModel",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.fileModel),f=e.assign;c.bind("change",function(){b.$apply(function(){f(b,c[0].files[0])})})}}}]),angular.module("publicApp").service("GondolaService",["$http","$q",function(a,b){var c=this,d="http://localhost:3000";this.getFlavour=function(a){for(var b=Object.keys(a.flavours),c=b.length;c--;)a.flavours[b[c]]||b.splice(c,1);var d=b.sort(function(b,c){return-(a.flavours[b]-a.flavours[c])}),e=d[0]?d[0]+" & "+d[1]:"None yet";return e},this.uploadGondola=function(b){var c=new FormData;c.append("gondola",b);var e={withCredentials:!0,method:"POST",url:d+"/api",data:c,headers:{"Content-Type":void 0}};return a(e)},this.getRandom=function(){var e=b.defer();return a({method:"GET",url:d+"/api?random=1"}).then(function(a){a.data.flavour=c.getFlavour(a.data),e.resolve(a.data)},function(a){e.reject(a)}),e.promise},this.getSpecific=function(e){var f=b.defer();return a({method:"GET",url:d+"/api?id="+e}).then(function(a){a.data[0].flavour=c.getFlavour(a.data[0]),f.resolve(a.data[0])},function(a){f.reject(a)}),f.promise},this.updateGondola=function(c,e,f){var g={id:c},h=b.defer();return e&&(g.flavours=e),f&&(g.voted=f),a({method:"PUT",url:d+"/api",data:g}).then(function(a){h.resolve(a.data)},function(a){h.reject(a)}),h.promise}}]),angular.module("publicApp").service("UserService",["$http","$q",function(a,b){var c="http://localhost:3000";this.getUser=function(b){return a({method:"GET",url:c+"/user?id="+b})},this.createUser=function(b){return a({method:"POST",url:c+"/user",data:{signedRequest:b}})},this.updateUser=function(b){return a({method:"PUT",url:c+"/user",data:b})},this.uploadProfile=function(b){var d=new FormData;d.append("profile",b);var e={withCredentials:!0,method:"POST",url:c+"/user/pic",data:d,headers:{"Content-Type":void 0}};return a(e)}}]),angular.module("publicApp").controller("HeaderCtrl",["$scope","$state","$timeout","ezfb","GondolaService","UserService",function(a,b,c,d,e,f){a.user={},a.loginStatus={},a.login=function(){d.login(function(a){a.authResponse&&(f.createUser(a.authResponse.signedRequest),g(h))},{scope:"public_profile"})},a.updateUser=function(a){f.updateUser(a)};var g=function(b){d.getLoginStatus(function(c){a.loginStatus=c,(b||angular.noop)()})},h=function(){d.api("/me",function(b){a.apiMe=b,a.getUser(a.apiMe.id)})};a.getUser=function(b){f.getUser(b).then(function(b){a.user=b.data})},a.uploadProfile=function(){f.uploadProfile(a.profileFile).then(function(b){$("#profileModal").modal("hide"),c(function(){a.user.pic=b.data.pic},1e3)},function(a){console.log(a)})},g(h)}]),angular.module("publicApp").controller("ProfileCtrl",["$scope","$state","$stateParams","$http","UserService",function(a,b,c,d,e){a.user={},e.getUser(c.id).then(function(b){console.log(b),a.user=b.data})}]),angular.module("publicApp").controller("MainCtrl",["$scope","$state","$stateParams","$http","GondolaService","UserService",function(a,b,c,d,e,f){var g={},h="";a.gondola={},a.owner={},a.$watch("gondola",function(c,d){b.go("home",{gondola:c._id},{notify:!1,reload:!0}),g={},h="",f.getUser(c.owner).then(function(b){a.owner=b.data})}),a.getSpecificGondola=function(b){e.getSpecific(b).then(function(b){a.gondola=b})},a.getRandomGondola=function(){e.getRandom().then(function(b){a.gondola=b})},a.uploadGondola=function(){e.uploadGondola(a.gondolaFile).then(function(b){a.gondola=b.data,$("#myModal").modal("hide")},function(a){console.log(a)})},a.updateVote=function(a,b,c){"umami"==c&&"notUmami"==h||"notUmami"==c&&"umami"==h||(c==h?(h="",b[c]-=1):(h=c,b[c]+=1),e.updateGondola(a,null,b))},a.updateFlavour=function(b,c,d){d in g?(delete g[d],c[d]-=1):(g[d]=1,c[d]+=1),console.log(c),e.updateGondola(b,c).then(function(b){console.log(b),a.gondola.flavour=e.getFlavour(b)})},a.goToProfile=function(a){b.go("profile",{id:a})},c.gondola?a.getSpecificGondola(c.gondola):a.getRandomGondola(),$("#myModal").on("hidden.bs.modal",function(c){b.go("home",{gondola:a.gondola._id},{notify:!1,reload:!0})})}]),angular.module("publicApp").run(["$templateCache",function(a){a.put("views/main.html",'<div class="row"> <div class="col-sm-12"> <a href="" ng-click="getRandomGondola()"> <img ng-src="http://localhost:3000/uploads/gondola/{{gondola.file.thumbnail}}" alt="Gondola"> </a> </div> </div> <div class="row"> <div class="col-sm-12"> <h4>Score: <span class="badge">{{gondola.voted.umami - gondola.voted.notUmami}}</span> Flavour: <span class="badge">{{gondola.flavour}}</span></h4> </div> </div> <div class="row"> <div class="col-sm-2"> <a href="#/profile/{{owner.id}}"><img ng-src="http://localhost:3000/uploads/profile/{{owner.pic}}" alt="owner" width="80" height="80"></a> </div> <div class="col-sm-10"> <form> <div class="btn-group" role="group"> <button class="btn btn-success" ng-click="updateVote(gondola._id, gondola.voted, \'umami\')"> Umami <span class="badge">{{gondola.voted.umami}}</span> </button> <button class="btn btn-danger" ng-click="updateVote(gondola._id, gondola.voted, \'notUmami\')"> Not Umami <span class="badge">{{gondola.voted.notUmami}}</span> </button> </div> <button type="button" class="btn btn-primary" data-toggle="button" aria-pressed="false" autocomplete="off" ng-click="updateFlavour(gondola._id, gondola.flavours, \'sweet\')"> Sweet <span class="badge">{{gondola.flavours.sweet}}</span> </button> <button type="button" class="btn btn-primary" data-toggle="button" aria-pressed="false" autocomplete="off" ng-click="updateFlavour(gondola._id, gondola.flavours, \'salty\')"> Salty <span class="badge">{{gondola.flavours.salty}}</span> </button> <button type="button" class="btn btn-primary" data-toggle="button" aria-pressed="false" autocomplete="off" ng-click="updateFlavour(gondola._id, gondola.flavours, \'bitter\')"> Bitter <span class="badge">{{gondola.flavours.bitter}}</span> </button> <button type="button" class="btn btn-primary" data-toggle="button" aria-pressed="false" autocomplete="off" ng-click="updateFlavour(gondola._id, gondola.flavours, \'sour\')"> Sour <span class="badge">{{gondola.flavours.sour}}</span> </button> </form> </div> </div> <!-- Modal --> <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> <h4 class="modal-title" id="myModalLabel">Upload a Gondola</h4> </div> <div class="modal-body"> <form name="gondolaForm" ng-submit="uploadGondola()" enctype="multipart/form-data"> <input type="file" class="btn btn-default" name="gondola" id="gondola" file-model="gondolaFile"> <br> <input type="submit" class="btn btn-primary" name="submit" value="Submit"> </form> </div> </div> </div> </div>'),a.put("views/profile.html",'<div class="row"> <div class="col-sm-12"> <img ng-src="http://localhost:3000/uploads/profile/{{user.pic}}" alt="owner"> </div> </div> <p>{{user.description}}</p> <h2>Favorite Gondola:</h2> <h2>Posted Gondolas:</h2>')}]);